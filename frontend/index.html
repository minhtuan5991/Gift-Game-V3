<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>üéÅ Ch·ªçn Ph·∫ßn Qu√† üéÅ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:'Segoe UI',sans-serif;background:url('bg.jpg') no-repeat center center fixed;background-size:cover;text-align:center;padding:40px 20px}
h1{color:#f8312f;font-size:2.5em;margin-bottom:10px}
.music-toggle{position:fixed;top:20px;right:20px;background:#fff;border-radius:25px;padding:8px 14px;border:none;cursor:pointer;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.2)}
.box-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,140px));gap:25px;justify-content:center;margin-top:40px}
.box{aspect-ratio:1/1;background-size:cover;border-radius:15px;cursor:pointer;transition:.3s}
.box:hover{transform:scale(1.05);filter:brightness(1.1)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10}
.modal-content{background:#fff;margin:18% auto;padding:30px;border-radius:12px;width:90%;max-width:800px;font-size:2em;font-weight:700;color:#004d40;position:relative;text-align:center;overflow:hidden}
.close-btn{position:absolute;right:20px;top:10px;font-size:24px;cursor:pointer}
.star-btn{width:90px;height:90px;background:url('star.png') center/contain no-repeat;border:none;margin-top:20px;cursor:pointer;display:none;animation:pulse 1.5s infinite}
.star-btn.spin{animation:spin .8s linear}
.star-btn.gray{filter:grayscale(100%) brightness(.7)}
@keyframes pulse{0%{scale:1}50%{scale:1.15}100%{scale:1}}
@keyframes spin{from{rotate:0deg}to{rotate:360deg}}
.star-result{margin-top:15px;font-size:1.2em}
</style>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>

<button id="musicToggle" class="music-toggle">üîä Nh·∫°c: ON</button>

<h1>üéÅ Ch·ªçn Ph·∫ßn Qu√† üéÅ</h1>
<div class="box-container" id="boxContainer"></div>

<div id="popup" class="modal">
<div class="modal-content" id="modalBox">
<span class="close-btn" onclick="closePopup()">&times;</span>
<div id="questionText"></div>
<button id="starBtn" class="star-btn"></button>
<div id="starResult" class="star-result"></div>
</div>
</div>

<audio id="bgMusic" src="bg-music.mp3" loop></audio>
<audio id="openSound" src="open.png"></audio>
<audio id="luckySound" src="lucky.mp3"></audio>
<audio id="unluckySound" src="unlucky.mp3"></audio>

<audio id="score5" src="score5.mp3"></audio>
<audio id="score55" src="score55.mp3"></audio>
<audio id="score6" src="score6.mp3"></audio>
<audio id="score65" src="score65.mp3"></audio>
<audio id="score7" src="score7.mp3"></audio>
<audio id="score75" src="score75.mp3"></audio>
<audio id="score8" src="score8.mp3"></audio>
<audio id="score85" src="score85.mp3"></audio>
<audio id="score9" src="score9.mp3"></audio>
<audio id="score95" src="score95.mp3"></audio>

<footer>‚ô• Ch√∫c B·∫°n May M·∫Øn ‚ô•</footer>

<script>
/* ================= SOCKET ================= */
const socket = io("https://gift-game-v3.onrender.com");

let me=null;
let currentTurn=null;
let isHost=false;

/* ================= MUSIC ================= */
const bgMusic=document.getElementById("bgMusic");
const musicToggle=document.getElementById("musicToggle");
let musicEnabled=true;
bgMusic.volume=0.3;

document.addEventListener("click",()=>{if(bgMusic.paused&&musicEnabled)bgMusic.play()},{once:true});
function bgLow(){if(musicEnabled)bgMusic.volume=0.09}
function bgNormal(){if(musicEnabled)bgMusic.volume=0.3}

musicToggle.onclick=()=>{
 musicEnabled=!musicEnabled;
 if(musicEnabled){bgMusic.play();bgMusic.volume=0.3;musicToggle.textContent="üîä Nh·∫°c: ON"}
 else{bgMusic.pause();musicToggle.textContent="üîá Nh·∫°c: OFF"}
};

/* ================= QUESTIONS ================= */
const questions=[
"5ƒë-C√≤n g√¨ ƒë·ªÉ m·∫•t ƒë√¢u, li·ªÅu ƒÉn nhi·ªÅu th√¥i n√†oüòá",
"5.5ƒë-Nay ch∆∞a th·∫Øp h∆∞∆°ng √†üòò",
"6ƒë-C≈©ng ƒë√°ng th·ª≠ ng√¥i sao may m·∫Øn ƒë·∫•yü§î",
"6.5ƒë-C√≥ t√†i r·ªìi b·∫•m ng√¥i sao xem c√≥ x·ªâu kh√¥ng n√†oü•∞",
"7ƒë-Kh√° qu√° nh·ªâ, ch·∫Øc l√† th√¥i ch·ª© ng√¥i sao g√¨ n·ªØaüòò",
"7.5ƒë-Hay l√† th·ª≠ xem c√≤n may ƒë∆∞·ª£c h∆°n n·ªØa kh√¥ngüòò",
"8ƒë-Cao ƒë·∫•y, nh∆∞ng m√† ch∆∞a T√†y ƒë√¢uüòÇ",
"8.5ƒë-Ch·ªçn Ng√¥i sao ƒë∆∞·ª£c ƒÉn c·∫£ ng√£ n·∫±m imüòò",
"9ƒë-Nay ch·∫Øc h∆∞∆°ng kh√≥i ƒë·∫ßy ƒë·ªß ph·∫£i kh√¥ngüòÇ",
"9.5ƒë-Th·∫ßy Hu·∫•n sai r·ªìi, kh√¥ng l√†m m√† v·∫´n c√≥ ƒÉnüíñ"
];

const popup=document.getElementById("popup");
const modalBox=document.getElementById("modalBox");
const questionText=document.getElementById("questionText");
const boxContainer=document.getElementById("boxContainer");
const starBtn=document.getElementById("starBtn");
const starResult=document.getElementById("starResult");

const openSound=document.getElementById("openSound");
const luckySound=document.getElementById("luckySound");
const unluckySound=document.getElementById("unluckySound");

const closeImg="close.png";
const openImg="open.png";
let currentOpenedBox=null;

/* ===== SCORE SOUND ===== */
function extractScore(text){
 const m=text.match(/(\d+(?:\.\d+)?)/);
 return m?m[1]:null;
}

const scoreMap={
 "5":"score5","5.5":"score55","6":"score6","6.5":"score65",
 "7":"score7","7.5":"score75","8":"score8","8.5":"score85",
 "9":"score9","9.5":"score95"
};

function stopScoreSounds(){
 Object.values(scoreMap).forEach(id=>{
  const a=document.getElementById(id);
  if(a){a.pause();a.currentTime=0;}
 });
}

function playScoreSound(score){
 stopScoreSounds();
 const id=scoreMap[score];
 if(id){
  const a=document.getElementById(id);
  if(a){a.currentTime=0;a.play();}
 }
}

function stopStarSounds(){
 luckySound.pause();unluckySound.pause();
 luckySound.currentTime=0;unluckySound.currentTime=0;
}

/* ===== POPUP ===== */
function showPopup(text){
 questionText.innerText=text;
 popup.style.display="block";
 starBtn.style.display="inline-block";
 starBtn.classList.remove("gray");
 starBtn.disabled=false;
 starResult.innerText="";

 const s=extractScore(text);
 if(s)playScoreSound(s);

 stopStarSounds();
 bgLow();
}

function closePopup(){
 popup.style.display="none";
 stopStarSounds();
 stopScoreSounds();
 bgNormal();
 if(currentOpenedBox){
  currentOpenedBox.style.backgroundImage=`url(${closeImg})`;
  currentOpenedBox=null;
 }
}

/* ===== STAR ===== */
starBtn.onclick=()=>{
 starBtn.disabled=true;
 starBtn.classList.add("spin");
 setTimeout(()=>{
  starBtn.classList.remove("spin");
  const lucky=Math.random()<0.1;
  stopStarSounds();
  if(lucky){
    starResult.innerText="üòÑ 10 ƒêI·ªÇM-C√°c c·ª• g√°nh c√≤ng l∆∞ng";
    luckySound.play();
  }else{
    starResult.innerText="üò≠ 5ƒë-Th√¨ ph·∫£i, ph·∫£i g√¨ ·∫°";
    starBtn.classList.add("gray");
    unluckySound.play();
  }
 },800);
};

/* ===== BOX ===== */
for(let i=0;i<6;i++){
 const box=document.createElement("div");
 box.className="box";
 box.style.backgroundImage=`url(${closeImg})`;

 box.onclick=()=>{

  if(!me || !currentTurn) return;

  if(me.STT!==currentTurn.STT){
    alert("Ch∆∞a t·ªõi l∆∞·ª£t b·∫°n!");
    return;
  }

  socket.emit("chooseCell",{index:i});
 };

 boxContainer.appendChild(box);
}

/* ================= MULTIPLAYER ================= */

socket.on("joinOK",(st)=>{me=st;alert("Joined "+st.Ten);});

socket.on("turn",(st)=>{
 currentTurn=st;
 document.getElementById("turn").innerText="L∆∞·ª£t: "+st.Ten;
});

socket.on("cellChosen",(d)=>{

 const i=d.index;
 const boxes=document.querySelectorAll(".box");

 if(currentOpenedBox&&currentOpenedBox!==boxes[i])
   currentOpenedBox.style.backgroundImage=`url(${closeImg})`;

 const box=boxes[i];
 box.style.backgroundImage=`url(${openImg})`;
 currentOpenedBox=box;

 showPopup(d.question);
});

/* ================= HOST ================= */

socket.on("hostOK",()=>{
 isHost=true;
 alert("HOST MODE");
});

socket.on("hostFail",()=>{
 isHost=false;
 alert("Sai m√£ host");
});

/* ================= HOST / PLAYER ================= */

function hostLogin(){
 socket.emit("hostJoin",
 document.getElementById("hostCode").value);
}

function uploadList(){

 if(!isHost){
  alert("B·∫°n kh√¥ng ph·∫£i host!");
  return;
 }

 const f=document.getElementById("listFile").files[0];
 const fd=new FormData();
 fd.append("file",f);

 fetch("https://gift-game-v3.onrender.com/upload",{
  method:"POST",
  body:fd
 }).then(r=>r.json()).then(j=>alert("Uploaded "+j.count));
}

function join(){
 socket.emit("playerJoin",
 document.getElementById("maSV").value);
}
</script>

<div style="position:fixed;top:10px;left:10px;background:#fff;padding:10px">
<h3>HOST</h3>
<input id="hostCode" placeholder="Host Code">
<button onclick="hostLogin()">Host</button><br>

<input type="file" id="listFile">
<button onclick="uploadList()">Upload DS</button><br>

<button onclick="if(isHost) socket.emit('startGame'); else alert('Kh√¥ng ph·∫£i host')">Start</button>
<button onclick="if(isHost) socket.emit('nextTurn'); else alert('Kh√¥ng ph·∫£i host')">Next</button>

<hr>

<h3>PLAYER</h3>
<input id="maSV" placeholder="MaSV">
<button onclick="join()">Join</button>
<div id="turn"></div>
</div>

</body>
</html>
