<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ğŸ Chá»n Pháº§n QuÃ  ğŸ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:'Segoe UI',sans-serif;background:url('bg.jpg') no-repeat center center fixed;background-size:cover;text-align:center;padding:40px 20px}
h1{color:#f8312f;font-size:2.5em;margin-bottom:10px}
.music-toggle{position:fixed;top:20px;right:20px;background:#fff;border-radius:25px;padding:8px 14px;border:none;cursor:pointer;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.2)}
.box-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,140px));gap:25px;justify-content:center;margin-top:40px}
.box{aspect-ratio:1/1;background-size:cover;border-radius:15px;cursor:pointer;transition:.3s}
.box:hover{transform:scale(1.05);filter:brightness(1.1)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10}
.modal-content{background:#fff;margin:18% auto;padding:30px;border-radius:12px;width:90%;max-width:800px;font-size:2em;font-weight:700;color:#004d40;position:relative;text-align:center;overflow:hidden}
.close-btn{position:absolute;right:20px;top:10px;font-size:24px;cursor:pointer}
.star-btn{width:90px;height:90px;background:url('star.png') center/contain no-repeat;border:none;margin-top:20px;cursor:pointer;display:none;animation:pulse 1.5s infinite}
.star-btn.spin{animation:spin .8s linear}
.star-btn.gray{filter:grayscale(100%) brightness(.7)}
.star-result{margin-top:15px;font-size:1.2em}
</style>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>

<button id="musicToggle" class="music-toggle">ğŸ”Š Nháº¡c: ON</button>

<h1>ğŸ Chá»n Pháº§n QuÃ  ğŸ</h1>
<div class="box-container" id="boxContainer"></div>

<div id="popup" class="modal">
<div class="modal-content" id="modalBox">
<span class="close-btn" onclick="closePopup()">&times;</span>
<div id="questionText"></div>
<button id="starBtn" class="star-btn"></button>
<div id="starResult" class="star-result"></div>
</div>
</div>

<audio id="bgMusic" src="bg-music.mp3" loop></audio>
<audio id="luckySound" src="lucky.mp3"></audio>
<audio id="unluckySound" src="unlucky.mp3"></audio>

<audio id="score5" src="score5.mp3"></audio>
<audio id="score55" src="score55.mp3"></audio>
<audio id="score6" src="score6.mp3"></audio>
<audio id="score65" src="score65.mp3"></audio>
<audio id="score7" src="score7.mp3"></audio>
<audio id="score75" src="score75.mp3"></audio>
<audio id="score8" src="score8.mp3"></audio>
<audio id="score85" src="score85.mp3"></audio>
<audio id="score9" src="score9.mp3"></audio>
<audio id="score95" src="score95.mp3"></audio>

<script>
const socket = io("https://gift-game-v3.onrender.com");

let me=null,currentTurn=null;
let currentOpenedBox=null;

/* ===== DOM ===== */
const popup=document.getElementById("popup");
const questionText=document.getElementById("questionText");
const starBtn=document.getElementById("starBtn");
const starResult=document.getElementById("starResult");

/* ===== MUSIC ===== */
const bgMusic=document.getElementById("bgMusic");
let musicEnabled=true;
bgMusic.volume=0.3;

function bgLow(){ if(musicEnabled) bgMusic.volume=0.09 }
function bgNormal(){ if(musicEnabled) bgMusic.volume=0.3 }

document.addEventListener("click",()=>{ 
 if(bgMusic.paused && musicEnabled) bgMusic.play();
},{once:true});

/* ===== SCORE ===== */
function extractScore(t){
 const m=t.match(/(\d+(?:\.\d+)?)/);
 return m?m[1]:null;
}

const scoreMap={
 "5":"score5","5.5":"score55","6":"score6","6.5":"score65",
 "7":"score7","7.5":"score75","8":"score8","8.5":"score85",
 "9":"score9","9.5":"score95"
};

function stopScoreSounds(){
 Object.values(scoreMap).forEach(id=>{
  const a=document.getElementById(id);
  if(a){a.pause();a.currentTime=0;}
 });
}

function playScoreSound(score){
 stopScoreSounds();
 const a=document.getElementById(scoreMap[score]);
 if(a){a.currentTime=0;a.play();}
}

function stopStarSounds(){
 luckySound.pause();
 unluckySound.pause();
 luckySound.currentTime=0;
 unluckySound.currentTime=0;
}

/* ===== POPUP ===== */
function showPopup(text){

 questionText.innerText=text;
 popup.style.display="block";

 starBtn.style.display="inline-block";
 starBtn.disabled=false;
 starBtn.classList.remove("gray");
 starResult.innerText="";

 const s=extractScore(text);
 if(s) playScoreSound(s);

 stopStarSounds();
 bgLow();
}

function closePopup(){
 popup.style.display="none";
 stopStarSounds();
 stopScoreSounds();
 bgNormal();
}

/* ===== STAR ===== */
starBtn.onclick=()=>{

 if(me?.STT!==currentTurn?.STT) return;

 starBtn.disabled=true;
 starBtn.classList.add("spin");

 const lucky=Math.random()>0.5;

 setTimeout(()=>{
  starBtn.classList.remove("spin");

  if(lucky){
    starResult.innerText="ğŸ˜„ 10 ÄIá»‚M";
    luckySound.play();
  }else{
    starResult.innerText="ğŸ˜­ 5Ä‘";
    unluckySound.play();
    starBtn.classList.add("gray");
  }
 },800);
};

/* ===== BOX ===== */
const boxes=[];
for(let i=0;i<6;i++){
 const b=document.createElement("div");
 b.className="box";
 b.style.backgroundImage="url(close.png)";

 b.onclick=()=>{
  if(me?.STT!==currentTurn?.STT) return alert("ChÆ°a tá»›i lÆ°á»£t!");
  socket.emit("chooseCell",{index:i});
 };

 boxes.push(b);
 document.getElementById("boxContainer").appendChild(b);
}

/* ===== SOCKET ===== */

socket.on("joinOK",st=>me=st);
socket.on("turn",st=>currentTurn=st);

socket.on("cellChosen",d=>{
 // backend pháº£i gá»­i question
 showPopup(d.question);
});
</script>

</body>
</html>
