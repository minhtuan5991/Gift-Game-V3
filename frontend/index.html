<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
const socket = io("https://gift-game-v3.onrender.com");

let me = null;
let currentTurn = null;

/* ================= MULTIPLAYER ================= */

socket.on("joinOK",st=>{
 me = st;
 alert("Joined " + st.Ten);
});

socket.on("joinFail",()=>alert("Sai m√£"));

socket.on("turn",st=>{
 currentTurn = st;
 const t = document.getElementById("turn");
 if(t) t.innerText = "L∆∞·ª£t: " + st.Ten;
});

/* ===== STAR ===== */
starBtn.onclick=()=>{

 if(!me || !currentTurn) return alert("Ch∆∞a t·ªõi l∆∞·ª£t!");

 if(me.STT !== currentTurn.STT)
   return alert("Ch∆∞a t·ªõi l∆∞·ª£t b·∫°n!");

 starBtn.disabled=true;
 starBtn.classList.add("spin");

 socket.emit("spin-star");
};

/* ===== BOX ===== */
const boxes=[];
for(let i=0;i<6;i++){
 const box=document.createElement("div");
 box.className="box";
 box.style.backgroundImage=`url(${closeImg})`;

 box.onclick=()=>{

  if(!me || !currentTurn)
    return alert("Ch∆∞a t·ªõi l∆∞·ª£t!");

  if(me.STT !== currentTurn.STT)
    return alert("Ch∆∞a t·ªõi l∆∞·ª£t b·∫°n!");

  socket.emit("open-box", i);
 };

 boxes.push(box);
 boxContainer.appendChild(box);
}

/* ===== REALTIME EVENTS ===== */

socket.on("box-opened",data=>{
 const { boxId, question } = data;

 if(currentOpenedBox && currentOpenedBox!==boxes[boxId])
   currentOpenedBox.style.backgroundImage=`url(${closeImg})`;

 const box=boxes[boxId];
 box.style.backgroundImage=`url(${openImg})`;
 currentOpenedBox=box;

 openSound.play();
 showPopup(question);
});

socket.on("star-result",data=>{
 const { lucky } = data;

 starBtn.classList.remove("spin");
 stopStarSounds();

 if(lucky){
  starResult.innerText="üòÑ 10 ƒêI·ªÇM-C√°c c·ª• g√°nh c√≤ng l∆∞ng";
  luckySound.play();
  fireworks();confettiRain();
 }else{
  starResult.innerText="üò≠ 5ƒë-Th√¨ ph·∫£i, ph·∫£i g√¨ ·∫°";
  starBtn.classList.add("gray");
  unluckySound.play();
 }
});

/* ===== SYNC RESET ===== */

socket.on("sync",()=>{
 boxes.forEach(b=>{
  b.style.backgroundImage=`url(${closeImg})`;
 });

 popup.style.display="none";
 currentOpenedBox=null;
});
</script>
